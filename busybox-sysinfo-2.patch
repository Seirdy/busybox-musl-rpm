From 67905e2d7c6ee273b753af22fb22de0ebec918c1 Mon Sep 17 00:00:00 2001
From: Denys Vlasenko <vda.linux@googlemail.com>
Date: Tue, 26 Jul 2011 11:42:12 +0000
Subject: *: work around sysinfo.h versus linux/*.h problems

Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>
---
Index: busybox-1.18.2/include/libbb.h
===================================================================
--- busybox-1.18.2.orig/include/libbb.h
+++ busybox-1.18.2/include/libbb.h
@@ -44,10 +44,12 @@
 #ifdef HAVE_SYS_STATFS_H
 # include <sys/statfs.h>
 #endif
-/* struct sysinfo is linux-specific */
-#ifdef __linux__
-# include <sys/sysinfo.h>
-#endif
+/* Don't do this here:
+ * #include <sys/sysinfo.h>
+ * Some linux/ includes pull in conflicting definition
+ * of struct sysinfo (only in some toolchanins), which breaks build.
+ * Include sys/sysinfo.h only in those files which need it.
+ */
 #if ENABLE_SELINUX
 # include <selinux/selinux.h>
 # include <selinux/context.h>
Index: busybox-1.18.2/init/init.c
===================================================================
--- busybox-1.18.2.orig/init/init.c
+++ busybox-1.18.2/init/init.c
@@ -113,7 +113,8 @@
 #include <paths.h>
 #include <sys/resource.h>
 #ifdef __linux__
-#include <linux/vt.h>
+# include <linux/vt.h>
+# include <sys/sysinfo.h>
 #endif
 #if ENABLE_FEATURE_UTMP
 # include <utmp.h> /* DEAD_PROCESS */
Index: busybox-1.18.2/procps/free.c
===================================================================
--- busybox-1.18.2.orig/procps/free.c
+++ busybox-1.18.2/procps/free.c
@@ -10,6 +10,9 @@
 /* getopt not needed */
 
 #include "libbb.h"
+#ifdef __linux__
+# include <sys/sysinfo.h>
+#endif
 
 struct globals {
 	unsigned mem_unit;
Index: busybox-1.18.2/procps/ps.c
===================================================================
--- busybox-1.18.2.orig/procps/ps.c
+++ busybox-1.18.2/procps/ps.c
@@ -16,6 +16,9 @@ enum { MAX_WIDTH = 2*1024 };
 
 #if ENABLE_DESKTOP
 
+#ifdef __linux__
+# include <sys/sysinfo.h>
+#endif
 #include <sys/times.h> /* for times() */
 #ifndef AT_CLKTCK
 #define AT_CLKTCK 17
Index: busybox-1.18.2/procps/uptime.c
===================================================================
--- busybox-1.18.2.orig/procps/uptime.c
+++ busybox-1.18.2/procps/uptime.c
@@ -16,6 +16,10 @@
 /* getopt not needed */
 
 #include "libbb.h"
+#ifdef __linux__
+# include <sys/sysinfo.h>
+#endif
+
 
 #ifndef FSHIFT
 # define FSHIFT 16              /* nr of bits of precision */
